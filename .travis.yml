# Control file for continuous integration testing at http://travis-ci.org/

language: c

matrix:
  include:
  - compiler: gcc-8
    os: linux
    env: USE_CONFIG=yes CC=gcc-8 AR=gcc-ar-8
    addons:
      apt:
        sources:
          - ubuntu-toolchain-r-test
        packages:
          - gcc-8

  - compiler: gcc-8
    os: linux
    env: USE_CONFIG=yes USE_LIBDEFLATE=yes CC=gcc-8 AR=gcc-ar-8
    addons:
      apt:
        sources:
          - ubuntu-toolchain-r-test
        packages:
          - gcc-8

  - compiler: clang
    os: osx
    env: USE_CONFIG=no

  - compiler: clang
    os: osx
    env: USE_CONFIG=yes

  - compiler: clang
    os: osx
    env: USE_CONFIG=yes USE_LIBDEFLATE=yes

  - compiler: gcc
    os: linux
    env: USE_CONFIG=no

  - compiler: gcc
    os: linux
    env: USE_CONFIG=yes

  - compiler: clang
    os: linux
    env: USE_CONFIG=yes

# For MacOSX systems
before_install:
  - if [[ "$TRAVIS_OS_NAME" == "osx" && "$USE_CONFIG" == "no" ]]; then HOMEBREW_NO_AUTO_UPDATE=1 brew install xz || ( brew update && brew install xz ); fi

before_script:
  - if test "x$USE_LIBDEFLATE" == "xyes" ; then ( cd "$HOME" && git clone --depth 1 https://github.com/ebiggers/libdeflate.git && cd libdeflate && make -j 2 CFLAGS='-fPIC -O3' libdeflate.a ); fi

script:
  - if test "x$USE_LIBDEFLATE" = "xyes" ; then CONFIG_OPTS='CPPFLAGS="-I$HOME/libdeflate" LDFLAGS="-L$HOME/libdeflate" --with-libdeflate' ; else CONFIG_OPTS='--without-libdeflate' ; fi
  - if test "$USE_CONFIG" = "yes" ; then autoreconf && eval ./configure --enable-werror $CONFIG_OPTS CFLAGS=\"-g -O3\" || { cat config.log ; false ; } ; fi && make -j 2 -e && make test
